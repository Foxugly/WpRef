<div class="page">
  <div class="header-line">
    <div class="header-left">
      <h1 class="title">Éditer le sujet</h1>
      <p class="subtitle muted">Traductions et contenu</p>
    </div>

    <div class="header-actions">
      <p-button
        type="button"
        icon="pi pi-arrow-left"
        label="Retour"
        severity="secondary"
        (onClick)="goList()">
      </p-button>

      <p-button
        type="button"
        icon="pi pi-save"
        label="Enregistrer"
        (onClick)="save()">
      </p-button>
    </div>
  </div>

  @if (loading()) {
    <div class="card">
      <p class="muted">Chargement…</p>
    </div>
  } @else {

    <!-- FORM CARD -->
    <form class="card form-card" [formGroup]="form" (ngSubmit)="save()">
      <div class="card-head">
        <h2 class="card-title">Traductions</h2>
        <span class="badge">{{ allowedLanguages().length }} langue(s)</span>
      </div>

      <p-tabs class="tabs" [(value)]="activeTabIndex">
        <p-tablist>
          @for (lang of allowedLanguages(); track lang.code) {
            <p-tab [value]="$index">{{ lang.code.toUpperCase() }}</p-tab>
          }
        </p-tablist>

        <p-tabpanels>
          @for (lang of allowedLanguages(); track lang.code) {
            <p-tabpanel [value]="$index">

              <div formGroupName="translations" class="lang-panel">
                <div class="form-grid" [formGroupName]="lang.code">

                  <div class="field">
                    <label class="field-label">Nom</label>
                    <input pInputText formControlName="name" placeholder="Nom du sujet" />
                    @if (
                      langGroup(lang.code).get('name')?.touched &&
                      langGroup(lang.code).get('name')?.invalid
                    ) {
                      <small class="field-error">Nom requis (min. 2 caractères)</small>
                    }
                  </div>

                  <div class="field field--full">
                    <label class="field-label">Description</label>
                    <p-editor formControlName="description" [style]="{ height: '220px' }"></p-editor>
                  </div>

                </div>
              </div>

            </p-tabpanel>
          }
        </p-tabpanels>
      </p-tabs>

      <div class="footer-actions">
        <p-button type="submit" icon="pi pi-save" label="Enregistrer"></p-button>
        <p-button
          type="button"
          icon="pi pi-times"
          severity="secondary"
          label="Annuler"
          (onClick)="goList()">
        </p-button>
      </div>
    </form>

    <!-- RELATED LIST CARD -->
    <div class="card">
      <div class="card-head">
        <h2 class="card-title">Questions</h2>
        <div class="card-actions">
          <p-button
            type="button"
            icon="pi pi-plus"
            label="Ajouter"
            severity="secondary"
            (onClick)="goQuestionNew()">
          </p-button>
        </div>
      </div>

      @if ((questions || []).length === 0) {
        <p class="muted empty-state">Aucune question.</p>
      } @else {
        <table class="table">
          <thead>
            <tr>
              <th>Titre</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>

          <tbody>
            @for (q of questions; track q[id]) {
              <tr>
                <td class="truncate">{{ q }}</td>
                <td class="col-actions">
                  <div class="row-actions">
                    <p-button
                      type="button"
                      icon="pi pi-pencil"
                      severity="info"
                      size="small"
                      (onClick)="goQuestionEdit(q[id])">
                    </p-button>
                    <p-button
                      type="button"
                      icon="pi pi-trash"
                      severity="danger"
                      size="small"
                      (onClick)="goQuestionDelete(q[id])">
                    </p-button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
    </div>
  }
</div>
