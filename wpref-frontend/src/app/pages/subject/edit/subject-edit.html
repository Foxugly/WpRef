<div class="page">
  <div class="header-line header-line--grid">
    <div class="header-spacer"></div>

    <div class="header-center">
      <h1 class="title">Éditer le sujet</h1>
      <p class="subtitle muted">Traductions et contenu</p>
    </div>

    <div class="header-actions">
      <p-button
        (onClick)="goList()"
        icon="pi pi-arrow-left"
        label="Retour"
        severity="secondary"
        type="button">
      </p-button>

      <p-button
        (onClick)="save()"
        icon="pi pi-save"
        label="Enregistrer"
        type="button">
      </p-button>
    </div>
  </div>

  @if (loading()) {
    <div class="card">
      <p class="muted">Chargement…</p>
    </div>
  } @else {

    <!-- FORM CARD -->
    <form (ngSubmit)="save()" [formGroup]="form" class="card form-card">
      <div class="card-head card-head--with-badge">
        <h2 class="card-title">Traductions</h2>
        <span class="badge">{{ allowedLanguages().length }} langue(s)</span>
      </div>

      <p-tabs
        (valueChange)="onTabChange($event)"
        [value]="activeLang() ?? undefined"
        class="tabs">
        <p-tablist>
          @for (lang of allowedLanguages(); track lang.code) {
            <p-tab [value]="lang.code">{{ lang.code.toUpperCase() }}</p-tab>
          }
        </p-tablist>

        <p-tabpanels>
          @for (lang of allowedLanguages(); track lang.code) {
            <p-tabpanel [value]="lang.code">
              <div class="lang-panel" formGroupName="translations">
                <div class="lang-toolbar">
                  <p-button
                    (click)="translateFromActiveTab()"
                    [disabled]="translating()"
                    [loading]="translating()"
                    icon="pi pi-language"
                    label="Traduire vers les autres langues"
                    severity="info"
                    type="button">
                  </p-button>
                </div>
                <div [formGroupName]="lang.code" class="meta-grid">
                  <div class="meta-item meta-item--full">
                    <label class="meta-label">Nom ({{ lang.code.toUpperCase() }})</label>
                    <div class="meta-value">
                      <input formControlName="name" pInputText placeholder="Nom du sujet"/>
                    </div>

                    @if (langGroup(lang.code).get('name')?.touched &&
                    langGroup(lang.code).get('name')?.invalid) {
                      <div class="meta-hint meta-hint--error">
                        Nom requis (min. 2 caractères)
                      </div>
                    }
                  </div>

                  <div class="meta-item meta-item--full">
                    <label class="meta-label">Description ({{ lang.code.toUpperCase() }})</label>
                    <div class="meta-value">
                      <p-editor
                        class="editor-compact"
                        formControlName="description">
                      </p-editor>
                    </div>
                  </div>
                </div>
              </div>
            </p-tabpanel>
          }
        </p-tabpanels>
      </p-tabs>

      <div class="footer-actions">
        <p-button icon="pi pi-save" label="Enregistrer" type="submit"></p-button>
        <p-button
          (onClick)="goList()"
          icon="pi pi-times"
          label="Annuler"
          severity="secondary"
          type="button">
        </p-button>
      </div>
    </form>

    <!-- RELATED LIST CARD -->
    <div class="card">
      <div class="card-head">
        <h2 class="card-title">Questions</h2>
        <div class="header-actions">
          <p-button
            (onClick)="goQuestionNew()"
            icon="pi pi-plus"
            label="Ajouter"
            severity="primary"
            type="button">
          </p-button>
        </div>
      </div>

      @if ((questions() || []).length === 0) {
        <p class="muted empty-state">Aucune question.</p>
      } @else {
        <p-table
          [value]="questions()"
          showGridlines
          size="small"
          stripedRows
          styleClass="table"
        >
          <ng-template #header>
            <tr>
              <th>Titre</th>
              <th class="col-actions">Actions</th>
            </tr>
          </ng-template>

          <ng-template #body let-q>
            <tr>
              <td class="truncate">{{ getQuestionTitle(q) }}</td>
              <td class="col-actions">
                <div class="row-actions">
                  <p-button
                    (onClick)="goQuestionEdit(q.id)"
                    icon="pi pi-pencil"
                    severity="info"
                    size="small"
                    type="button">
                  </p-button>
                  <p-button
                    (onClick)="goQuestionDelete(q[id])"
                    icon="pi pi-trash"
                    severity="danger"
                    size="small"
                    type="button">
                  </p-button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </div>
  }
</div>
