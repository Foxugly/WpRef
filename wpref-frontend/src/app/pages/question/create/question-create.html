<div class="page">
  <!-- HEADER -->
  <div class="header-line header-line--grid">
    <div class="header-spacer"></div>

    <div class="header-center">
      <h1 class="title">Créer une question</h1>
      <p class="subtitle muted">Domaine, sujets, traductions et réponses</p>
    </div>

    <div class="header-actions">
      <p-button
        (onClick)="goBack()"
        icon="pi pi-arrow-left"
        label="Retour"
        severity="secondary"
        type="button">
      </p-button>
    </div>
  </div>

  <!-- LOADING -->
  @if (loading()) {
    <div class="card">
      <p class="muted">Chargement…</p>
    </div>
  } @else {

    <!-- ERROR -->
    @if (error()) {
      <div class="card">
        <div class="alert alert--error">{{ error() }}</div>
      </div>
    }

    <form (ngSubmit)="save()" [formGroup]="form" class="form-stack">
      <!-- CARD: Contexte -->
      <div class="card form-card">
        <div class="card-head">
          <h2 class="card-title">Contexte</h2>
        </div>

        <div class="meta-grid">
          <!-- DOMAIN -->
          <div class="meta-item">
            <label class="meta-label">Domaine</label>
            <div class="meta-value">
              <p-select
                [filter]="true"
                [options]="domainOptions()"
                formControlName="domain"
                optionLabel="name"
                optionValue="id"
                placeholder="Choisir un domaine">
              </p-select>
            </div>
          </div>

          <!-- SUBJECTS -->
          <div class="meta-item">
            <label class="meta-label">Sujets</label>
            <div class="meta-value">
              <p-multiSelect
                [filter]="true"
                [options]="subjectOptions()"
                [showClear]="true"
                formControlName="subject_ids"
                optionLabel="name"
                optionValue="code"
                placeholder="Sélectionner un ou plusieurs sujets">
              </p-multiSelect>
            </div>
          </div>
        </div>

        <div class="meta-grid meta-grid--compact">
          <div class="meta-item">
            <label class="meta-label">Active</label>
            <div class="meta-value widget-center">
              <p-checkbox [binary]="true" formControlName="active"></p-checkbox>
            </div>
          </div>

          <div class="meta-item">
            <label class="meta-label">Mode</label>
            <div class="meta-value mode-row widget-center">
              <label class="mode-chip">
                <p-checkbox [binary]="true" formControlName="is_mode_practice"></p-checkbox>
                <span>Pratique</span>
                <p-button
                  icon="pi pi-info-circle"
                  pTooltip="la question sera publique et sélectionnable pour les quizzes générés."
                  severity="secondary"
                  tooltipPosition="top"
                  type="button">
                </p-button>
              </label>

              <label class="mode-chip">
                <p-checkbox [binary]="true" formControlName="is_mode_exam"></p-checkbox>
                <span>Examen</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 2 colonnes: Contenu (2/3) + Médias (1/3) -->
      @if (form.controls.domain.value) {
        <div class="split-grid">
          <!-- LEFT: Tabs / contenu -->
          <div class="card form-card split-left">
            @if (tabCodes().length > 0) {
              <div class="card-head">
                <h2 class="card-title">Contenu</h2>
              </div>

              <p-tabs
                (valueChange)="onTabChange($event)"
                [value]="activeLang() ?? undefined"
                class="tabs tabs--tight">

                <p-tablist>
                  @for (lang of tabCodes(); track lang) {
                    <p-tab [value]="lang">{{ lang.toUpperCase() }}</p-tab>
                  }
                </p-tablist>

                <p-tabpanels class="tabpanels-tight">
                  @for (lang of tabCodes(); track lang) {
                    <p-tabpanel [value]="lang">
                      <div class="lang-panel">
                        <div class="lang-toolbar">
                          <p-button
                            (click)="translateFromActiveTab()"
                            [disabled]="translating()"
                            [loading]="translating()"
                            icon="pi pi-language"
                            label="Traduire vers les autres langues"
                            severity="info"
                            type="button">
                          </p-button>
                        </div>

                        <!-- Translations group -->
                        <div formGroupName="translations">
                          @if (translationsGroup().contains(lang)) {
                            <div [formGroupName]="lang" class="meta-grid">
                              <!-- TITLE -->
                              <div class="meta-item meta-item--full">
                                <label class="meta-label">Titre ({{ lang.toUpperCase() }})</label>
                                <div class="meta-value">
                                  <input formControlName="title" pInputText placeholder="Titre..."/>
                                </div>
                                @if (form.get(['translations', lang, 'title'])?.invalid && form.get(['translations', lang, 'title'])?.touched) {
                                  <div class="meta-hint meta-hint--error">Titre requis (min. 2 caractères).</div>
                                }
                              </div>

                              <!-- DESCRIPTION -->
                              <div class="meta-item meta-item--full">
                                <label class="meta-label">Description ({{ lang.toUpperCase() }})</label>
                                <div class="meta-value">
                                  <p-editor class="editor-compact" formControlName="description"></p-editor>
                                </div>
                              </div>

                              <!-- ANSWERS -->
                              <div class="meta-item meta-item--full">
                                <label class="meta-label">Réponses possibles ({{ lang.toUpperCase() }})</label>

                                <p-panel class="answers">
                                  @for (group of answerOptions.controls; track i; let i = $index) {
                                    <div class="answer">
                                      <!-- checkbox -->
                                      <div class="answer__correct" [formGroup]="answerMetaGroup(i)">
                                        <label class="meta-label">Bonne réponse</label>
                                        <p-checkbox
                                          [binary]="true"
                                          formControlName="is_correct"
                                          (onChange)="answerMetaGroup(i).get('is_correct')?.setValue($event.checked)"
                                          >
                                        </p-checkbox>
                                      </div>

                                      <!-- contenu -->
                                      <div class="answer__content">
                                        <label class="meta-label">Contenu ({{ lang.toUpperCase() }})</label>
                                        <p-editor
                                          [formControl]="answerContentCtrl(i, lang)"
                                          class="editor-compact">
                                        </p-editor>
                                      </div>

                                      <!-- delete -->
                                      <div class="answer__delete">
                                        <p-button
                                          (click)="removeOption(i)"
                                          icon="pi pi-trash"
                                          pTooltip="Supprimer cette réponse"
                                          severity="danger"
                                          size="small"
                                          type="button"
                                          variant="text">
                                        </p-button>
                                      </div>
                                    </div>

                                    <p-divider></p-divider>
                                  }

                                  <p-button
                                    (click)="addOption()"
                                    icon="pi pi-plus"
                                    label="Ajouter une réponse"
                                    severity="primary"
                                    size="small"
                                    type="button"
                                    variant="outlined">
                                  </p-button>
                                </p-panel>
                              </div>

                              <!-- EXPLANATION -->
                              <div class="meta-item meta-item--full">
                                <label class="meta-label">Explication ({{ lang.toUpperCase() }})</label>
                                <div class="meta-value">
                                  <p-editor class="editor-compact" formControlName="explanation"></p-editor>
                                </div>
                              </div>
                            </div>
                          }
                        </div>

                        @if (translating()) {
                          <div class="inline-status">
                            <i class="pi pi-spin pi-spinner"></i>
                            <span>Traduction en cours…</span>
                          </div>
                        }
                      </div>
                    </p-tabpanel>
                  }
                </p-tabpanels>
              </p-tabs>
            } @else {
              <div class="alert alert--info">
                Ce domaine n’a pas de langues actives configurées.
              </div>
            }
          </div>

          <!-- RIGHT: Media (1/3) -->
          <div class="card form-card split-right">
            <div class="card-head">
              <h2 class="card-title">Médias</h2>
            </div>

            <div class="meta-grid">
              <div class="meta-item meta-item--full">
                <label class="meta-label">Média</label>
                <div class="meta-value widget-center">
                  <app-media-selector formControlName="media"></app-media-selector>
                </div>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- SUBMIT ERROR -->
      @if (submitError()) {
        <div class="card">
          <div class="alert alert--error">{{ submitError() }}</div>
        </div>
      }

      <!-- FOOTER ACTIONS -->
      <div class="footer-actions">
        <p-button
          [disabled]="saving() || translating()"
          [loading]="saving()"
          icon="pi pi-save"
          label="Créer"
          type="submit">
        </p-button>

        <p-button
          (onClick)="goBack()"
          icon="pi pi-times"
          label="Annuler"
          severity="secondary"
          type="button">
        </p-button>
      </div>
    </form>
  }
</div>
