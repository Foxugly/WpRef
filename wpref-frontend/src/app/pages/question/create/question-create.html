<div class="page">
  <h1>Créer une question</h1>

  @if (loading()) {
    <div>Chargement…</div>
  }
  @if (error()) {
    <div class="error">
      {{ error() }}
    </div>
  }

  @if (!loading()) {
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Titre -->
      <div class="field">
        <label for="title">Titre</label>
        <input id="title" type="text" formControlName="title"/>
        @if (form.get('title')?.invalid && form.get('title')?.touched) {
          <div class="error">
            Le titre est obligatoire.
          </div>
        }
      </div>

      <!-- Sujets -->
      <div class="field">
        <label for="subjects">Sujets</label>

        <app-multi-select
          id="subjects"
          formControlName="subject_ids"
          [options]="subjectOptions"
          [multiple]="true"
          placeholder="Sélectionner un ou plusieurs sujets"
        ></app-multi-select>

        <small>
          Tu peux sélectionner plusieurs sujets dans le menu.
        </small>
      </div>

      <div class="field">
        fichiers - TODO
      </div>

      <!-- Description -->
      <div class="field">
        <label for="description">Description</label>
        <ckeditor
          [editor]="Editor"
          formControlName="description"
        ></ckeditor>
      </div>

      <!-- Autorise plusieurs bonnes réponses -->
      <div class="field field--inline">
        <label>
          <input type="checkbox" formControlName="allow_multiple_correct"/>
          Autoriser plusieurs réponses correctes
        </label>
      </div>
      <div class="field field--inline">
        <label>
          <input type="checkbox" formControlName="is_mode_practice"/>
          Question pour s'exercer ?
        </label>
      </div>
      <div class="field field--inline">
        <label>
          <input type="checkbox" formControlName="is_mode_exam"/>
          Question pour des examens ?
        </label>
      </div>

      <!-- Réponses -->
      <fieldset class="answers" formArrayName="answer_options">
        <legend>Réponses possibles</legend>

        @for (group of answerOptions.controls; track $index; let i = $index) {
          <div class="answer" [formGroupName]="i">

            <div class="field">
              <label for="answer-{{ i }}-content">Réponse {{ i + 1 }}</label>
              <textarea id="answer-{{ i }}-content" formControlName="content"></textarea>
            </div>

            <div class="field field--inline">
              <label>
                <input type="checkbox" formControlName="is_correct"/>
                Bonne réponse
              </label>

              <button
                class="btn small-blue"
                type="button"
                (click)="setOnlyCorrect(i)"
              >
                Marquer comme seule correcte
              </button>
            </div>

            <div class="field field--inline">
              <label for="answer-{{ i }}-order">Ordre :</label>
              <input
                id="answer-{{ i }}-order"
                type="number"
                formControlName="sort_order"
                class="answer__order-input"
              />
            </div>

            <button
              type="button"
              class="btn btn--danger"
              (click)="removeOption(i)"
            >
              Supprimer cette réponse
            </button>
          </div>
        }

        <button
          type="button"
          class="btn btn--secondary"
          (click)="addOption()"
        >
          Ajouter une réponse
        </button>
      </fieldset>


      <!-- Explication -->
      <div class="field">
        <label for="explanation">Explication</label>
        <ckeditor
          [editor]="Editor"
          formControlName="explanation"
        ></ckeditor>
      </div>

      @if (success()) {
        <div class="success">
          {{ success() }}
        </div>
      }
      <button
        class="btn btn--primary"
        type="submit"
        [disabled]="saving() || form.invalid"
      >
        {{ saving() ? 'Enregistrement…' : 'Enregistrer' }}
      </button>
    </form>
  }
</div>
